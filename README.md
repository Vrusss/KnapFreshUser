# Расширение для создания условного пользователя для обмена (в разработке)

Расширение написано на Бухгалтерия предприятия, редакция 3.0 (3.0.173.23) для работы в следующих системах:
Файловая, "1С Фреш", "42 Cloud"

Предназначение расширения - создание, через общую форму, условного пользователя для обмена, который будет иметь полные права и
ему будет запрещено заходить в режим Предприятия. Также, нужно не пускать в режим предприятия предустановленных клиентом пользователей,
из систем "1С Фреш" и "42 Cloud" 

Примечание: 
- Для хранения данных имени созданного условного пользователя используется регистр сведений БезопасноеХранилищеОбластейДанных
- Автор не имеет права загрузить файл расширения в репозиторий, т.к. разработка ведется в расширении клиента, где находятся его собственные разработки

# бит_ЗагрузкаОСв1С

## Модуль объекта
	// Ищет в регистре сведений БезопасноеХранилищеДанныхОбластейДанных имя условного пользователя
 	// если находит, то возвращает имя, если нет, то Неопределено
 	// Возвращаемаое значение:
  	//	- Строка
   	//	- Неопределено
	Функция ПолучитьИмяУП() Экспорт // ++ Мальцев В.К. PBSD-5482
	
		УстановитьПривилегированныйРежим(Истина);
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	БезопасноеХранилищеДанныхОбластейДанных.Данные КАК Данные
			|ИЗ
			|	РегистрСведений.БезопасноеХранилищеДанныхОбластейДанных КАК БезопасноеХранилищеДанныхОбластейДанных
			|ГДЕ
			|	БезопасноеХранилищеДанныхОбластейДанных.Владелец = &Владелец";
		
		Запрос.УстановитьПараметр("Владелец", "бит_УсловныйПользователь");
		
		РезультатЗапроса = Запрос.Выполнить();
		
		Выборка = РезультатЗапроса.Выбрать();
		
		Если Выборка.Следующий() Тогда
			Данные = Выборка.Данные.Получить();
			Имя = Данные.Имя
		Иначе
			Имя = Неопределено
		КонецЕсли;
		
		УстановитьПривилегированныйРежим(Ложь);
		
		Возврат Имя;
		
	КонецФункции // -- Мальцев В.К. PBSD-5482 
	// Проверяет наличиче у текущего пользоваетля полных прав
 	// Возвращаемое значение:
  	//	Булево
	функция ПолучитьПраваТекущегоПользователя() Экспорт
		Пользователь = ПользователиИнформационнойБазы.ТекущийПользователь();
		
		Если Не ЗначениеЗаполнено(Пользователь.Имя) Тогда
			Возврат Истина;
		КонецЕсли;
		
		ПраваИмеются = Пользователь.Роли.Содержит(Метаданные.Роли["ПолныеПрава"]);
		
		Возврат ПраваИмеются;
	КонецФункции

## Модуль приложения
	// Проверяет, по имени, можно ли пустить текущего пользователя в режим Предприятия, если у него есть полные права, 
	&После("ПриНачалеРаботыСистемы")
	Процедура бит_ПриНачалеРаботыСистемы() // ++ Мальцев В.К. PBSD-5482
		
		Если бит_ОбщийМодульУП.ПолучитьПраваТекущегоПользователя() Тогда
			ТекущийПользователь = ИмяПользователя();
			УсловныйПользователь = бит_ОбщийМодульУП.ПолучитьИмяУП();
					
			Если ТекущийПользователь = "knapfresh" ИЛИ ТекущийПользователь = "42Cloud" 
				ИЛИ ТекущийПользователь = УсловныйПользователь Тогда
				ЗавершитьРаботуСистемы(Ложь, ); 
			КонецЕсли;
			
		КонецЕсли;
		
	КонецПроцедуры // -- Мальцев В.К. PBSD-548
